<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Frontend Lesson Debug</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .debug-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>üîç Frontend Lesson Debug Tool</h1>

    <div class="debug-section">
      <h3>1. API Test</h3>
      <button onclick="testAPI()">Test API for Jake Ferguson</button>
      <div id="apiResult"></div>
    </div>

    <div class="debug-section">
      <h3>2. Student Profile Simulation</h3>
      <button onclick="simulateLogin()">Simulate Jake Ferguson Login</button>
      <div id="loginResult"></div>
    </div>

    <div class="debug-section">
      <h3>3. Lesson Rendering Test</h3>
      <button onclick="testLessonRendering()">Test Lesson Rendering</button>
      <div id="renderResult"></div>
    </div>

    <div class="debug-section">
      <h3>4. Console Logs</h3>
      <div
        id="consoleLogs"
        style="
          background: #f0f0f0;
          padding: 10px;
          height: 200px;
          overflow-y: auto;
        "
      ></div>
    </div>

    <script>
      // Capture console logs
      const originalLog = console.log;
      const originalError = console.error;
      const originalWarn = console.warn;
      const logContainer = document.getElementById('consoleLogs');

      function addToConsoleLog(type, message) {
        const div = document.createElement('div');
        div.innerHTML = `<span style="color: ${type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black'}">[${type.toUpperCase()}] ${message}</span>`;
        logContainer.appendChild(div);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      console.log = function (...args) {
        originalLog.apply(console, args);
        addToConsoleLog('log', args.join(' '));
      };

      console.error = function (...args) {
        originalError.apply(console, args);
        addToConsoleLog('error', args.join(' '));
      };

      console.warn = function (...args) {
        originalWarn.apply(console, args);
        addToConsoleLog('warn', args.join(' '));
      };

      async function testAPI() {
        const resultDiv = document.getElementById('apiResult');
        resultDiv.innerHTML = '<p class="info">Testing API...</p>';

        try {
          console.log('üîç Testing API endpoint...');
          const response = await fetch(
            'http://localhost:3000/student/Jake Ferguson/assignedUnits',
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          console.log('‚úÖ API Response received:', data);

          resultDiv.innerHTML = `
                    <p class="success">‚úÖ API Success: ${data.success}</p>
                    <p class="info">Units: ${data.assignedUnits ? data.assignedUnits.length : 0}</p>
                    <p class="info">Total Lessons: ${data.assignedUnits && data.assignedUnits[0] ? data.assignedUnits[0].lessons.length : 0}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
        } catch (error) {
          console.error('‚ùå API Test Failed:', error);
          resultDiv.innerHTML = `<p class="error">‚ùå API Error: ${error.message}</p>`;
        }
      }

      function simulateLogin() {
        const resultDiv = document.getElementById('loginResult');
        resultDiv.innerHTML = '<p class="info">Simulating login...</p>';

        try {
          // Simulate student profile object
          const studentProfile = {
            memberName: 'Jake Ferguson',
            username: 'Jake Ferguson',
            teacher: 'admin@trinity-capital.net',
            classPeriod: '1',
          };

          console.log('üë§ Simulating student profile:', studentProfile);

          // Store in session storage like the real app
          sessionStorage.setItem(
            'studentProfile',
            JSON.stringify(studentProfile),
          );

          resultDiv.innerHTML = `
                    <p class="success">‚úÖ Profile stored in session</p>
                    <pre>${JSON.stringify(studentProfile, null, 2)}</pre>
                `;
        } catch (error) {
          console.error('‚ùå Login simulation failed:', error);
          resultDiv.innerHTML = `<p class="error">‚ùå Login Error: ${error.message}</p>`;
        }
      }

      async function testLessonRendering() {
        const resultDiv = document.getElementById('renderResult');
        resultDiv.innerHTML = '<p class="info">Testing lesson rendering...</p>';

        try {
          // Get stored profile
          const profileData = sessionStorage.getItem('studentProfile');
          if (!profileData) {
            throw new Error(
              'No student profile found. Run login simulation first.',
            );
          }

          const studentProfile = JSON.parse(profileData);
          console.log('üìö Testing renderLessons with profile:', studentProfile);

          // Simulate the lessonEngine renderLessons function
          const studentId =
            studentProfile.memberName ||
            studentProfile.username ||
            studentProfile._id;
          console.log('üîç Fetching assigned units for student:', studentId);

          const response = await fetch(
            `http://localhost:3000/student/${studentId}/assignedUnits`,
          );

          if (!response.ok) {
            throw new Error(
              `Failed to fetch assigned units: ${response.status}`,
            );
          }

          const data = await response.json();
          console.log('üìä Received data:', data);

          if (!data.success || !data.assignedUnits) {
            throw new Error('No assigned units data received');
          }

          const assignedUnits = data.assignedUnits;
          console.log(`‚úÖ Received ${assignedUnits.length} assigned units`);

          if (assignedUnits.length === 0) {
            throw new Error('No lessons assigned yet');
          }

          // Check unit structure
          const unit = assignedUnits[0];
          console.log('üîç Unit structure check:');
          console.log('- unitName:', unit.unitName);
          console.log('- unitValue:', unit.unitValue);
          console.log('- lessons array:', Array.isArray(unit.lessons));
          console.log(
            '- lessons count:',
            unit.lessons ? unit.lessons.length : 0,
          );

          if (unit.lessons && unit.lessons.length > 0) {
            console.log('üìù First lesson structure:');
            console.log('- lesson_title:', unit.lessons[0].lesson_title);
            console.log('- _id:', unit.lessons[0]._id);
          }

          resultDiv.innerHTML = `
                    <p class="success">‚úÖ Lesson rendering test passed!</p>
                    <p class="info">Units: ${assignedUnits.length}</p>
                    <p class="info">Unit Name: ${unit.unitName}</p>
                    <p class="info">Unit Value: ${unit.unitValue}</p>
                    <p class="info">Lessons: ${unit.lessons ? unit.lessons.length : 0}</p>
                    <p class="info">Has lessons array: ${Array.isArray(unit.lessons)}</p>
                    <p class="info">Lessons length > 0: ${unit.lessons && unit.lessons.length > 0}</p>
                `;
        } catch (error) {
          console.error('‚ùå Lesson rendering test failed:', error);
          resultDiv.innerHTML = `<p class="error">‚ùå Rendering Error: ${error.message}</p>`;
        }
      }

      // Auto-run API test on page load
      window.addEventListener('load', () => {
        console.log('üöÄ Frontend Debug Tool loaded');
        testAPI();
      });
    </script>
  </body>
</html>
