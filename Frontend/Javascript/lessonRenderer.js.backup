'use strict';

// Import instruction templates for generating student instructions
import {
  getInstructionTemplate,
  hasInstructionTemplate,
  getAvailableConditionTypes,
} from './instructionTemplates.js';

/**
 * Trinity Capital - Lesson Renderer
 *
 * Clean implementation following architecture rules:
 * - Headers + text blocks are grouped
 * - Multiple text blocks with no header appear standalone
 * - Consecutive headers render independently
 * - Uses real lesson schema with content array
 * - Uses separated instruction templates for maintainability
 */

class LessonRenderer {
  /**
   * Fetch available lessons for the current student using assignedUnitIds.lessonIds
   * @returns {Promise<Array>} Promise resolving to an array of lesson objects
   */
  async getAvailableLessons() {
    console.log('üîÑ Getting available lessons...');
    try {
      // Get the current student name
      const studentName = this.currentStudent;
      if (!studentName) {
        console.error('‚ùå No current student set in lessonRenderer');
        return [];
      }

      console.log(`üîç Fetching profile for student: ${studentName}`);

      // Fetch the student profile directly from the server
      try {
        const profileResponse = await fetch(
          `http://localhost:3000/profiles/${encodeURIComponent(studentName)}`,
        );

        if (!profileResponse.ok) {
          console.error(
            `‚ùå Failed to fetch student profile: ${profileResponse.status} ${profileResponse.statusText}`,
          );

          // Fallback to global profile if available
          const fallbackProfile =
            window.currentStudentProfile ||
            (window.lessonRenderer &&
              window.lessonRenderer.currentStudentProfile);

          if (fallbackProfile) {
            console.log('‚ö†Ô∏è Using fallback profile from global state');

            // Store the profile for future use
            this.currentStudentProfile = fallbackProfile;

            // Continue with fallback profile
            return this.processProfileForLessons(fallbackProfile);
          }

          return [];
        }

        // Parse the profile from the response
        const profile = await profileResponse.json();
        console.log('‚úÖ Successfully fetched student profile');

        // Store the profile for future use
        this.currentStudentProfile = profile;

        // Process the profile to get lessons
        return this.processProfileForLessons(profile);
      } catch (fetchError) {
        console.error('‚ùå Error fetching student profile:', fetchError);

        // Fallback to global profile
        const fallbackProfile =
          window.currentStudentProfile ||
          (window.lessonRenderer &&
            window.lessonRenderer.currentStudentProfile);

        if (fallbackProfile) {
          console.log('‚ö†Ô∏è Using fallback profile due to fetch error');

          // Store the profile for future use
          this.currentStudentProfile = fallbackProfile;

          // Continue with fallback profile
          return this.processProfileForLessons(fallbackProfile);
        }

        return [];
      }
    } catch (error) {
      console.error('‚ùå Error in getAvailableLessons:', error);
      return [];
    }
  }

  /**
   * Process a student profile to extract and fetch lessons
   * @param {Object} profile - The student profile object
   * @returns {Promise<Array>} Promise resolving to an array of lesson objects
   * @private
   */
  async processProfileForLessons(profile) {
    // Log detailed profile information
    console.log('üë§ Processing profile:', {
      memberName: profile.memberName,
      hasAssignedUnitIds: !!profile.assignedUnitIds,
      assignedUnitIdsType: profile.assignedUnitIds
        ? typeof profile.assignedUnitIds
        : 'undefined',
      isArray: profile.assignedUnitIds
        ? Array.isArray(profile.assignedUnitIds)
        : false,
      length:
        profile.assignedUnitIds && Array.isArray(profile.assignedUnitIds)
          ? profile.assignedUnitIds.length
          : 0,
    });

    // Check for valid assignedUnitIds
    if (
      !profile ||
      !Array.isArray(profile.assignedUnitIds) ||
      profile.assignedUnitIds.length === 0
    ) {
      console.warn('‚ö†Ô∏è No assignedUnitIds found in student profile');
      console.log(
        'üìã Full profile structure:',
        JSON.stringify(profile, null, 2),
      );
      return [];
    }

    // Get Unit 1 lessons first, then all other lessons
    let orderedUnits = [...profile.assignedUnitIds];

    // Sort units to put unit1 first
    orderedUnits.sort((a, b) => {
      if (a.unitId === 'unit1' || a.unitValue === 'unit1') return -1;
      if (b.unitId === 'unit1' || b.unitValue === 'unit1') return 1;
      return 0;
    });

    console.log(
      'üìã Units in order:',
      orderedUnits.map(u => u.unitName || u.unitId),
    );

    // Gather all lessonIds from all assigned units (in correct order)
    const lessonIds = orderedUnits
      .flatMap(unit => {
        // Detailed logging for each unit
        console.log(`üîç Processing unit: ${unit.unitName || unit.unitId}`);
        console.log(`   - lessonIds exists: ${!!unit.lessonIds}`);
        console.log(`   - lessonIds type: ${typeof unit.lessonIds}`);
        console.log(
          `   - lessonIds is array: ${Array.isArray(unit.lessonIds)}`,
        );
        if (Array.isArray(unit.lessonIds)) {
          console.log(`   - lessonIds length: ${unit.lessonIds.length}`);
          console.log(
            `   - First few lessonIds: ${unit.lessonIds.slice(0, 3).join(', ')}${unit.lessonIds.length > 3 ? '...' : ''}`,
          );
        }

        return Array.isArray(unit.lessonIds) ? unit.lessonIds : [];
      })
      /**
       * Start a specific lesson - create modal that takes up the lessonsBlock
       * @param {Object} lesson - The lesson object to start
       */
      startLesson(lesson) {
        console.log(`üöÄ Starting lesson modal for: ${lesson.lesson_title}`);

        this.currentLesson = lesson;

        // Create modal overlay that covers the entire screen
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'lesson-modal-overlay';
        modalOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          backdrop-filter: blur(5px);
        `;

        // Create the modal dialog
        const modalDialog = document.createElement('div');
        modalDialog.className = 'lesson-modal-dialog';
        modalDialog.style.cssText = `
          width: 90%;
          max-width: 900px;
          height: 650px;
          background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
          border-radius: 20px;
          box-shadow: 0 25px 60px rgba(0,0,0,0.3);
          overflow: hidden;
          position: relative;
          animation: modalSlideIn 0.4s ease-out;
        `;

        // Add a "Begin Activities" button
        const beginButton = document.createElement('button');
        beginButton.textContent = 'Begin Activities';
        beginButton.style.cssText = `
          position: absolute;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          padding: 10px 20px;
          font-size: 16px;
          font-weight: bold;
          color: white;
          background: #3498db;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        `;

        // Add click handler to activate lesson tracking
        beginButton.addEventListener('click', () => {
          if (window.lessonEngine && window.lessonEngine.initialized) {
            window.lessonEngine.activateLesson(lesson).catch(err => {
              console.error('‚ùå Failed to activate lesson in lesson engine:', err);
            });
          } else {
            console.warn(
              '‚ö†Ô∏è Lesson engine is not initialized. Tracking will not be active.',
            );
          }
        });

        modalDialog.appendChild(beginButton);
        modalOverlay.appendChild(modalDialog);
        document.body.appendChild(modalOverlay);

        // Add animation keyframes
        if (!document.querySelector('#lesson-modal-styles')) {
          const styleSheet = document.createElement('style');
          styleSheet.id = 'lesson-modal-styles';
          styleSheet.textContent = `
            @keyframes modalSlideIn {
              from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
              }
              to {
                transform: translateY(0) scale(1);
                opacity: 1;
              }
            }
            @keyframes modalSlideOut {
              from {
                transform: translateY(0) scale(1);
                opacity: 1;
              }
              to {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
              }
            }
          `;
          document.head.appendChild(styleSheet);
        }
      }
    }

    // Log student profile and lesson IDs for debugging
    console.log('üë§ Student profile:', profile);
    console.log('üß© Lesson IDs to fetch:', lessonIds);

    // SUPER LOUD DEBUG BEFORE FETCH
    console.log(
      '%c üöÄ ATTEMPTING FETCH TO LESSON SERVER NOW üöÄ ',
      'background: #ff0000; color: white; font-size: 20px;',
    );
    console.log(
      '%c POST to http://localhost:4000/get-lessons-by-ids ',
      'background: #ff0000; color: white; font-size: 16px;',
    );
    console.log(
      '%c With lessonIds: ',
      'background: #ff0000; color: white; font-size: 14px;',
      lessonIds,
    );
    console.log(
      '%c Current Origin: ',
      'background: #ff0000; color: white; font-size: 14px;',
      window.location.origin,
    );

    try {
      // Define the URL with correct origin
      const lessonServerUrl = 'http://localhost:4000/get-lessons-by-ids';

      console.log(
        '%c Fetch URL: ',
        'background: #ff0000; color: white; font-size: 14px;',
        lessonServerUrl,
      );

      // Try first attempt with credentials: 'omit' (no credentials)
      console.log(
        '%c Trying fetch WITHOUT credentials',
        'color: orange; font-size: 14px;',
      );

      // POST lessonIds and student profile to backend to fetch lessons
      const response = await fetch(lessonServerUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          lessonIds, // Send just the array of lesson IDs
          studentName: profile.memberName || 'Unknown Student',
        }),
        credentials: 'omit', // No credentials to avoid CORS issues
        mode: 'cors', // Explicitly set CORS mode
      });

      console.log(
        '%c ‚úÖ FETCH RESPONSE RECEIVED ',
        'background: green; color: white; font-size: 16px;',
      );
      console.log('Response status:', response.status);

      if (!response.ok)
        throw new Error(
          `Failed to fetch lessons by IDs. Status: ${response.status}`,
        );

      const data = await response.json();
      console.log('üìö Full response data:', data);

      // Properly extract lessons based on response structure
      let lessons = [];
      if (Array.isArray(data)) {
        lessons = data;
      } else if (data && data.success && Array.isArray(data.lessons)) {
        lessons = data.lessons;
      } else if (data && Array.isArray(data.lessons)) {
        lessons = data.lessons;
      }

      console.log(`üìò Successfully extracted ${lessons.length} lessons`);
      return lessons;
    } catch (fetchError) {
      console.error(
        '%c ‚ùå FETCH ERROR: ',
        'background: red; color: white; font-size: 16px;',
        fetchError,
      );
      return [];
    }
  }

  /**
   * Render all content blocks as slides, including text slides
   * @param {Element} container - The container element
   * @param {Array} content - The content array
   */
  renderLessonContent(container, content) {
    // Remove old content
    container.innerHTML = '';

    // Create carousel wrapper
    const carouselId = 'lessonCarousel_' + Math.floor(Math.random() * 1000000);
    const carousel = document.createElement('div');
    carousel.id = carouselId;
    carousel.className = 'carousel slide';
    carousel.setAttribute('data-bs-ride', 'carousel');
    carousel.setAttribute('data-bs-wrap', 'true');

    // Carousel inner
    const carouselInner = document.createElement('div');
    carouselInner.className = 'carousel-inner';

    // Render all content blocks as slides
    const processedBlocks = this.processContentBlocks(content);
    processedBlocks.forEach((block, idx) => {
      const slide = document.createElement('div');
      slide.className = 'carousel-item';
      if (idx === 0) slide.classList.add('active');

      const contentBlock = this.createContentBlock(block, idx);
      slide.appendChild(contentBlock);
      carouselInner.appendChild(slide);
    });

    // Add instructions as the final slide
    const instructionsSlide = document.createElement('div');
    instructionsSlide.className = 'carousel-item';
    instructionsSlide.style.cssText = `
      min-height: 580px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    `;
    const instructionsList = document.createElement('div');
    instructionsList.className = 'instructions-list';
    instructionsList.style.cssText = `
      display: flex; 
      flex-direction: column; 
      gap: 15px; 
      max-width: 700px; 
      width: 100%;
      margin: 0 auto; 
      padding: 30px; 
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 15px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      color: #333;
      height: auto;
      max-height: 520px;
      overflow-y: auto;
    `;

    const lesson = this.currentLesson || {};
    const instructions = this.generateLessonEngineInstructions(lesson);
    if (instructions.length > 0) {
      instructions.forEach(instruction => {
        const instructionItem = document.createElement('div');
        instructionItem.className = 'instruction-item';
        instructionItem.textContent = instruction.text;
        instructionsList.appendChild(instructionItem);
      });
    } else {
      const noInstructions = document.createElement('p');
      noInstructions.textContent = 'No instructions available for this lesson.';
      instructionsList.appendChild(noInstructions);
    }

    instructionsSlide.appendChild(instructionsList);
    carouselInner.appendChild(instructionsSlide);

    carousel.appendChild(carouselInner);

    // Carousel controls
    if (processedBlocks.length > 1) {
      const prevControl = document.createElement('button');
      prevControl.className = 'carousel-control-prev';
      prevControl.setAttribute('type', 'button');
      prevControl.setAttribute('data-bs-target', `#${carouselId}`);
      prevControl.setAttribute('data-bs-slide', 'prev');
      prevControl.innerHTML = `
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      `;

      const nextControl = document.createElement('button');
      nextControl.className = 'carousel-control-next';
      nextControl.setAttribute('type', 'button');
      nextControl.setAttribute('data-bs-target', `#${carouselId}`);
      nextControl.setAttribute('data-bs-slide', 'next');
      nextControl.innerHTML = `
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      `;

      carousel.appendChild(prevControl);
      carousel.appendChild(nextControl);
    }

    container.appendChild(carousel);
    console.log('‚úÖ Lesson slides and instructions rendered successfully.');
  }

  /**
   * Check if a lesson is available to the student
   * @param {Object} lesson - The lesson object
   * @param {number} index - The lesson index
   * @returns {boolean} Whether the lesson is available
   */
  checkLessonAvailability(lesson, index) {
    // First lesson is always available
    if (index === 0) return true;

    // For now, assume lessons are available in sequence
    // This would be enhanced with actual gating logic
    return true;
  }

  /**
   * Start a specific lesson - create modal that takes up the lessonsBlock
   * @param {Object} lesson - The lesson object to start
   */
  startLesson(lesson) {
    console.log(`üöÄ Starting lesson modal for: ${lesson.lesson_title}`);
    this.currentLesson = lesson;

    // Remove any existing modal overlays
    const oldModal = document.querySelector('.lesson-modal-overlay');
    if (oldModal) oldModal.remove();

    // Create modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'lesson-modal-overlay';
    modalOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    `;

    // Create modal dialog
    const modalDialog = document.createElement('div');
    modalDialog.className = 'lesson-modal-dialog';
    modalDialog.style.cssText = `
      width: 90%;
      max-width: 900px;
      height: 650px;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 20px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.3);
      overflow-y: auto;
      position: relative;
      animation: modalSlideIn 0.4s ease-out;
      padding-bottom: 80px;
    `;

    // Content container for lesson blocks
    const contentContainer = document.createElement('div');
    contentContainer.className = 'lesson-modal-content';
    contentContainer.style.cssText = `
      padding: 32px 32px 0 32px;
      min-height: 400px;
    `;

    // Render lesson content
    if (!lesson || !Array.isArray(lesson.content) || lesson.content.length === 0) {
      contentContainer.innerHTML = '<div class="lesson-slide"><h3>No lesson content available.</h3></div>';
    } else {
      this.renderLessonContent(contentContainer, lesson.content);
    }

    // Render objectives if present
    if (lesson.learning_objectives && lesson.learning_objectives.length > 0) {
      const objectivesBlock = document.createElement('div');
      objectivesBlock.className = 'lesson-objectives-block';
      objectivesBlock.innerHTML = `<h4>üéØ Learning Objectives:</h4><ul>${lesson.learning_objectives.map(obj => `<li>${obj}</li>`).join('')}</ul>`;
      contentContainer.appendChild(objectivesBlock);
    }

    // Render lesson conditions if present
    if (lesson.lesson_conditions && lesson.lesson_conditions.length > 0) {
      const conditionsBlock = document.createElement('div');
      conditionsBlock.className = 'lesson-conditions-block';
      conditionsBlock.innerHTML = `<h4>üìã What you'll need to do:</h4><ul>${lesson.lesson_conditions.map(cond => `<li>${cond.type || cond}</li>`).join('')}</ul>`;
      contentContainer.appendChild(conditionsBlock);
    }

    modalDialog.appendChild(contentContainer);

    // Add a "Begin Activities" button
    const beginButton = document.createElement('button');
    beginButton.textContent = 'Begin Activities';
    beginButton.style.cssText = `
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      background: #3498db;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    `;
    beginButton.addEventListener('click', () => {
      if (window.lessonEngine && window.lessonEngine.initialized) {
        window.lessonEngine.activateLesson(lesson).catch(err => {
          console.error('‚ùå Failed to activate lesson in lesson engine:', err);
        });
      } else {
        console.warn('‚ö†Ô∏è Lesson engine is not initialized. Tracking will not be active.');
      }
    });
    modalDialog.appendChild(beginButton);

    modalOverlay.appendChild(modalDialog);
    document.body.appendChild(modalOverlay);

    // Add animation keyframes if not present
    if (!document.querySelector('#lesson-modal-styles')) {
      const styleSheet = document.createElement('style');
      styleSheet.id = 'lesson-modal-styles';
      styleSheet.textContent = `
        @keyframes modalSlideIn {
          from {
            transform: translateY(-50px) scale(0.9);
            opacity: 0;
          }
          to {
            transform: translateY(0) scale(1);
            opacity: 1;
          }
        }
        @keyframes modalSlideOut {
          from {
            transform: translateY(0) scale(1);
            opacity: 1;
          }
          to {
            transform: translateY(-50px) scale(0.9);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(styleSheet);
    }
  }

  /**
   * Display a list of lessons as circular buttons in a horizontal row
   * @param {Array} lessons - Array of lesson objects to display
   */
  displayLessonsList(lessons) {
    const container = document.querySelector('.lessonsBlock');
    if (!container) {
      console.error('‚ùå Lessons container not found on the page.');
      return;
    }

    // Clear existing content
    container.innerHTML = '';

    // Create a horizontal row container
    const rowContainer = document.createElement('div');
    rowContainer.style.cssText = `
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 15px;
      padding: 10px;
    `;

    lessons.forEach((lesson, index) => {
      const lessonButton = this.createCircularLessonButton(lesson, index);
      rowContainer.appendChild(lessonButton);
    });

    container.appendChild(rowContainer);
    console.log('‚úÖ Lessons displayed successfully in a horizontal row.');
  }

  /**
   * Render sample lesson content when actual content is missing
   * @param {Element} container - The container element
   * @param {Object} lesson - The lesson object
   */
  renderSampleContent(container, lesson) {
    console.log('üìö Rendering sample content for lesson:', lesson.lesson_title);

    // Create sample content based on lesson title
    const sampleContent = [];

    if (lesson.lesson_title?.toLowerCase().includes('money personality')) {
      sampleContent.push(
        { type: 'header', content: 'Understanding Your Money Personality' },
        {
          type: 'text',
          content:
            'Everyone has a unique relationship with money that affects how they spend, save, and make financial decisions.',
        },
        {
          type: 'text',
          content:
            'Understanding your money personality helps you make better financial choices and develop healthy money habits.',
        },
        { type: 'header', content: 'Needs vs Wants' },
        {
          type: 'text',
          content:
            'Learning to differentiate between needs and wants is crucial for financial success.',
        },
        {
          type: 'text',
          content:
            'Needs are essential items required for survival and basic functioning, such as food, shelter, and clothing.',
        },
        {
          type: 'text',
          content:
            'Wants are desires that improve quality of life but are not essential for survival, such as entertainment, luxury items, and dining out.',
        },
        { type: 'header', content: 'Identifying Your Money Type' },
        {
          type: 'text',
          content:
            'Are you a spender who enjoys purchasing things, or a saver who prefers to accumulate money for the future?',
        },
        {
          type: 'text',
          content:
            'Understanding your natural tendencies helps you create a budget and financial plan that works with your personality.',
        },
        { type: 'header', content: 'Building Healthy Money Habits' },
        {
          type: 'text',
          content:
            'Regardless of your money personality, everyone can benefit from tracking expenses, setting financial goals, and making informed spending decisions.',
        },
      );
    } else {
      // Generic sample content
      sampleContent.push(
        { type: 'header', content: 'Lesson Overview' },
        {
          type: 'text',
          content:
            'This lesson will help you understand important financial concepts and develop practical money management skills.',
        },
        {
          type: 'text',
          content:
            'You will learn through interactive activities and real-world applications using the Trinity Capital banking system.',
        },
        { type: 'header', content: 'Key Learning Objectives' },
        {
          type: 'text',
          content:
            'By the end of this lesson, you will be able to apply financial concepts in practical situations.',
        },
        {
          type: 'text',
          content:
            'You will gain hands-on experience with banking tools and develop confidence in managing your finances.',
        },
      );
    }

    // Render the sample content using the same architecture rules
    this.renderLessonContent(container, sampleContent);
  }

  /**
   * Convert lesson_blocks and intro_text_blocks to content format
   * @param {Object} lesson - The lesson object
   * @returns {Array} Converted content array
   */
  convertLessonBlocksToContent(lesson) {
    const content = [];

    // Add intro text blocks first
    if (lesson.intro_text_blocks && Array.isArray(lesson.intro_text_blocks)) {
      lesson.intro_text_blocks.forEach(block => {
        if (block.type === 'intro') {
          content.push({ type: 'header', content: 'Welcome!' });
          content.push({ type: 'text', content: block.content });
        } else {
          content.push({ type: 'text', content: block.content });
        }
      });
    }

    // Create comprehensive lesson content based on the title and description
    if (lesson.lesson_title) {
      content.push({ type: 'header', content: 'Lesson Introduction' });
      content.push({
        type: 'text',
        content:
          lesson.lesson_description ||
          'This lesson will help you develop important financial skills.',
      });

      // Add lesson-specific content based on title
      if (lesson.lesson_title.toLowerCase().includes('money personality')) {
        content.push(
          { type: 'header', content: 'Understanding Your Money Personality' },
          {
            type: 'text',
            content:
              'Everyone has a unique relationship with money that affects how they spend, save, and make financial decisions.',
          },
          {
            type: 'text',
            content:
              'Your money personality influences whether you tend to be a spender or a saver, how you approach financial risks, and what motivates your financial decisions.',
          },
          { type: 'header', content: 'Needs vs Wants' },
          {
            type: 'text',
            content:
              'One of the most important financial skills is learning to differentiate between needs and wants.',
          },
          {
            type: 'text',
            content:
              'Needs are essential items required for survival and basic functioning: food, shelter, clothing, transportation, and healthcare.',
          },
          {
            type: 'text',
            content:
              'Wants are desires that improve quality of life but are not essential: entertainment, luxury items, dining out, premium brands, and hobby expenses.',
          },
          { type: 'header', content: 'Identifying Your Money Type' },
          {
            type: 'text',
            content:
              'Are you a spender who enjoys purchasing things and finds satisfaction in acquiring new items?',
          },
          {
            type: 'text',
            content:
              'Or are you a saver who prefers to accumulate money for future security and long-term goals?',
          },
          {
            type: 'text',
            content:
              'Understanding your natural tendencies helps you create a budget and financial plan that works with your personality rather than against it.',
          },
          { type: 'header', content: 'Analyzing Your Spending Patterns' },
          {
            type: 'text',
            content:
              'By reviewing your bank account and transaction history, you can identify patterns in your spending behavior.',
          },
          {
            type: 'text',
            content:
              'Look for categories where you spend the most money and determine whether these are needs or wants.',
          },
          {
            type: 'text',
            content:
              'This analysis will help you understand your money personality and make more informed financial decisions.',
          },
        );
      } else if (lesson.lesson_title.toLowerCase().includes('goal setting')) {
        content.push(
          { type: 'header', content: 'SMART Financial Goals' },
          {
            type: 'text',
            content:
              'Effective financial goals follow the SMART criteria: Specific, Measurable, Attainable, Realistic, and Time-based.',
          },
          {
            type: 'text',
            content:
              'Specific goals clearly define what you want to achieve. Instead of "save money," try "save for a $5,000 emergency fund."',
          },
          {
            type: 'text',
            content:
              "Measurable goals include concrete numbers so you can track progress and know when you've succeeded.",
          },
          { type: 'header', content: 'Setting Realistic Targets' },
          {
            type: 'text',
            content:
              'Attainable goals are challenging but achievable given your current financial situation and income.',
          },
          {
            type: 'text',
            content:
              'Realistic goals consider your other financial obligations and life circumstances.',
          },
          {
            type: 'text',
            content:
              'Time-based goals have clear deadlines that create urgency and help you stay focused.',
          },
        );
      } else if (lesson.lesson_title.toLowerCase().includes('budget')) {
        content.push(
          { type: 'header', content: 'The 50/30/20 Budget Rule' },
          {
            type: 'text',
            content:
              'A popular budgeting method allocates your after-tax income into three categories.',
          },
          {
            type: 'text',
            content:
              '50% for needs: rent, groceries, utilities, minimum debt payments, and other essential expenses.',
          },
          {
            type: 'text',
            content:
              '30% for wants: dining out, entertainment, hobbies, and other discretionary spending.',
          },
          {
            type: 'text',
            content:
              '20% for savings and debt repayment: emergency fund, retirement savings, and extra debt payments.',
          },
          { type: 'header', content: 'Tracking Income and Expenses' },
          {
            type: 'text',
            content:
              'Start by calculating your total monthly after-tax income from all sources.',
          },
          {
            type: 'text',
            content:
              'Then categorize all your expenses to see how much you currently spend in each area.',
          },
          {
            type: 'text',
            content:
              'This baseline helps you identify areas where you can adjust spending to meet your budget goals.',
          },
        );
      } else {
        // Generic content for other lessons
        content.push(
          { type: 'header', content: 'Key Concepts' },
          {
            type: 'text',
            content:
              'This lesson covers essential financial concepts that will help you make better money decisions.',
          },
          {
            type: 'text',
            content:
              'You will learn practical skills that you can apply immediately in your personal financial life.',
          },
          { type: 'header', content: 'Practical Applications' },
          {
            type: 'text',
            content:
              'Through hands-on activities using the Trinity Capital banking system, you will practice these concepts in a safe environment.',
          },
          {
            type: 'text',
            content:
              'These exercises will build your confidence and prepare you for real-world financial decision-making.',
          },
        );
      }
    }

    // Add lesson blocks if they exist
    if (lesson.lesson_blocks && Array.isArray(lesson.lesson_blocks)) {
      lesson.lesson_blocks.forEach(block => {
        if (block.type === 'instruction') {
          content.push({ type: 'header', content: 'Instructions' });
          content.push({ type: 'text', content: block.content });
        } else if (block.type === 'action') {
          content.push({ type: 'header', content: 'Action Required' });
          content.push({ type: 'text', content: block.content });
        } else {
          content.push({ type: 'text', content: block.content });
        }
      });
    }

    console.log(`üìö Converted to ${content.length} content blocks`);
    return content;
  }

  /**
   * Process content blocks according to architecture rules
   * @param {Array} content - Raw content array
   * @returns {Array} Processed content blocks
   */
  processContentBlocks(content) {
    const processedBlocks = [];
    let currentGroup = null;

    for (let i = 0; i < content.length; i++) {
      const block = content[i];

      if (block.type === 'header') {
        // If we have a current group, finalize it
        if (currentGroup) {
          processedBlocks.push(currentGroup);
        }

        // Check if next block is also a header (consecutive headers)
        const nextBlock = content[i + 1];
        if (nextBlock && nextBlock.type === 'header') {
          // Render this header independently
          processedBlocks.push({
            type: 'standalone_header',
            content: [block],
          });
          currentGroup = null;
        } else {
          // Start new group with this header
          currentGroup = {
            type: 'header_group',
            content: [block],
          };
        }
      } else if (block.type === 'text') {
        if (currentGroup && currentGroup.type === 'header_group') {
          // Add to current header group
          currentGroup.content.push(block);
        } else {
          // Standalone text block or group with other text blocks
          if (!currentGroup || currentGroup.type !== 'text_group') {
            if (currentGroup) {
              processedBlocks.push(currentGroup);
            }
            currentGroup = {
              type: 'text_group',
              content: [],
            };
          }
          currentGroup.content.push(block);
        }
      } else {
        // Other content types
        if (currentGroup) {
          processedBlocks.push(currentGroup);
          currentGroup = null;
        }

        processedBlocks.push({
          type: 'standalone_content',
          content: [block],
        });
      }
    }

    // Add final group if exists
    if (currentGroup) {
      processedBlocks.push(currentGroup);
    }

    console.log(`üìö Processed into ${processedBlocks.length} content groups`);
    return processedBlocks;
  }

  /**
   * Create a visual content block element
   * @param {Object} block - The processed content block
   * @param {number} index - The block index
   * @returns {Element} The content block element
   */
  createContentBlock(block, index) {
    const blockContainer = document.createElement('div');
    blockContainer.className = `content-block ${block.type}`;
    blockContainer.style.cssText = `
      width: 100%;
      max-width: 700px;
      height: 450px;
      overflow-y: auto;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      border-left: 5px solid ${this.getBlockColor(block.type)};
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    `;

    // Add hover effect
    blockContainer.addEventListener('mouseenter', () => {
      blockContainer.style.transform = 'translateY(-2px)';
      blockContainer.style.boxShadow = '0 8px 30px rgba(0,0,0,0.12)';
    });

    blockContainer.addEventListener('mouseleave', () => {
      blockContainer.style.transform = 'translateY(0)';
      blockContainer.style.boxShadow = '0 5px 20px rgba(0,0,0,0.08)';
    });

    // Render content based on block type
    switch (block.type) {
      case 'header_group':
        this.renderHeaderGroup(blockContainer, block.content);
        break;
      case 'text_group':
        this.renderTextGroup(blockContainer, block.content);
        break;
      case 'standalone_header':
        this.renderStandaloneHeader(blockContainer, block.content[0]);
        break;
      case 'standalone_content':
        this.renderStandaloneContent(blockContainer, block.content[0]);
        break;
    }

    return blockContainer;
  }

  /**
   * Get color for different block types
   * @param {string} type - Block type
   * @returns {string} Color value
   */
  getBlockColor(type) {
    const colors = {
      header_group: '#3498db',
      text_group: '#27ae60',
      standalone_header: '#e74c3c',
      standalone_content: '#f39c12',
    };
    return colors[type] || '#95a5a6';
  }

  /**
   * Render header group (header + associated text blocks)
   * @param {Element} container - Container element
   * @param {Array} content - Content items
   */
  renderHeaderGroup(container, content) {
    content.forEach(item => {
      if (item.type === 'header') {
        const header = document.createElement('h2');
        header.textContent = item.content;
        header.style.cssText = `
          color: #2c3e50;
          font-size: 1.8rem;
          font-weight: 700;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 2px solid #3498db;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        `;
        container.appendChild(header);
      } else if (item.type === 'text') {
        const text = document.createElement('p');
        text.textContent = item.content;
        text.style.cssText = `
          color: #2c3e50;
          font-size: 1.1rem;
          line-height: 1.8;
          margin-bottom: 15px;
          text-align: justify;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        `;
        container.appendChild(text);
      }
    });
  }

  /**
   * Render text group (multiple text blocks without headers)
   * @param {Element} container - Container element
   * @param {Array} content - Content items
   */
  renderTextGroup(container, content) {
    content.forEach((item, index) => {
      const text = document.createElement('p');
      text.textContent = item.content;
      text.style.cssText = `
        color: #2c3e50;
        font-size: 1.1rem;
        line-height: 1.8;
        margin-bottom: 15px;
        text-align: justify;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding-left: ${index > 0 ? '20px' : '0'};
        border-left: ${index > 0 ? '3px solid #27ae60' : 'none'};
      `;
      container.appendChild(text);
    });
  }

  /**
   * Render standalone header (consecutive headers)
   * @param {Element} container - Container element
   * @param {Object} headerContent - Header content
   */
  renderStandaloneHeader(container, headerContent) {
    const header = document.createElement('h2');
    header.textContent = headerContent.content;
    header.style.cssText = `
      color: #2c3e50;
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin: 0;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    `;
    container.appendChild(header);
  }

  /**
   * Render standalone content (other content types)
   * @param {Element} container - Container element
   * @param {Object} content - Content item
   */
  renderStandaloneContent(container, content) {
    const div = document.createElement('div');
    div.textContent = content.content || '';
    div.style.cssText = `
      color: #2c3e50;
      font-size: 1.1rem;
      line-height: 1.8;
      text-align: center;
      font-style: italic;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    `;
    container.appendChild(div);
  }

  /**
   * Render instructions section using lesson engine
   * @param {Element} container - Container element
   * @param {Object} lesson - Lesson object
   */
  renderInstructions(container, lesson) {
    const instructionsContainer = document.createElement('div');
    instructionsContainer.className = 'lesson-instructions-section';
    instructionsContainer.style.cssText = `
      margin-top: 40px;
      padding: 30px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      border-radius: 15px;
      color: white;
    `;

    const instructionsTitle = document.createElement('h3');
    instructionsTitle.textContent = 'Your Tasks';
    instructionsTitle.style.cssText = `
      color: white;
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    `;

    const instructionsList = document.createElement('div');
    instructionsList.className = 'instructions-list';
    instructionsList.style.cssText =
      'display: flex; flex-direction: column; gap: 15px;';

    // Generate specific instructions using lesson engine
    console.log('üéØ Generating lesson instructions via lesson engine...');
    const specificInstructions = this.generateLessonEngineInstructions(lesson);

    specificInstructions.forEach((instruction, index) => {
      const instructionItem = document.createElement('div');
      instructionItem.style.cssText = `
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid rgba(255, 255, 255, 0.8);
        margin-bottom: 10px;
      `;

      // Create instruction with proper formatting
      const instructionContent = document.createElement('div');
      instructionContent.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 15px;">
          <div style="font-size: 1.5rem; line-height: 1;">${instruction.icon}</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 8px;">${instruction.title}</div>
            <div style="font-size: 0.95rem; line-height: 1.4; opacity: 0.9;">${instruction.description}</div>
            ${instruction.location ? `<div style=\"font-size: 0.85rem; margin-top: 8px; padding: 6px 12px; background: rgba(255,255,255,0.15); border-radius: 15px; display: inline-block;"><strong>Location:</strong> ${instruction.location}</div>` : ''}
          </div>
        </div>
      `;

      instructionItem.appendChild(instructionContent);
      instructionsList.appendChild(instructionItem);
    });

    // Add begin button
    const beginButton = document.createElement('button');
    beginButton.textContent = 'Begin Activities';
    beginButton.style.cssText = `
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: block;
      margin-left: auto;
      margin-right: auto;
    `;

    beginButton.addEventListener('click', async () => {
      await this.activateLessonTracking(lesson);
      // Close the modal instead of returning to lessons list
      const modalOverlay = container.closest('.lesson-modal-overlay');
      if (modalOverlay) {
        this.closeModal(modalOverlay);
      }
    });

    instructionsContainer.appendChild(instructionsTitle);
    instructionsContainer.appendChild(instructionsList);
    instructionsContainer.appendChild(beginButton);
    container.appendChild(instructionsContainer);
  }

  /**
   * Generate specific, actionable instructions using lesson engine logic
   * @param {Object} lesson - The lesson object with lesson_conditions
   * @returns {Array} Array of detailed instruction objects
   */
  generateLessonEngineInstructions(lesson) {
    const instructions = [];

    if (!lesson.lesson_conditions || !Array.isArray(lesson.lesson_conditions)) {
      console.warn('‚ö†Ô∏è No lesson conditions found for instruction generation');
      return [
        {
          icon: 'üìö',
          title: 'Complete the lesson activities',
          description: 'Follow the guidance provided to complete this lesson.',
          location: 'Use the Trinity Capital app features',
        },
      ];
    }

    // Process each lesson condition and generate specific instructions
    lesson.lesson_conditions.forEach((condition, index) => {
      const instruction = this.interpretConditionToInstruction(
        condition,
        lesson,
      );
      if (instruction) {
        instructions.push(instruction);
      }
    });

    // If no specific instructions were generated, provide fallback
    if (instructions.length === 0) {
      instructions.push({
        icon: 'üéØ',
        title: 'Complete lesson objectives',
        description:
          'Use the Trinity Capital banking app to practice the concepts covered in this lesson.',
        location: 'Navigate through the app sections as needed',
      });
    }

    return instructions;
  }

  /**
   * Interpret a lesson condition and generate specific app-based instruction
   * @param {Object} condition - Individual lesson condition
   * @param {Object} lesson - Full lesson object for context
   * @returns {Object} Detailed instruction object
   */
  interpretConditionToInstruction(condition, lesson) {
    console.log('üîç Processing condition:', condition.condition_type);

    // Get template from imported templates file - no more duplicate inline templates!
    const template = getInstructionTemplate(condition.condition_type);

    if (template) {
      // Add any additional context from action_details
      let enhancedDescription = template.description;
      if (condition.action_details?.message) {
        enhancedDescription += ` ${condition.action_details.message}`;
      }

      return {
        ...template,
        description: enhancedDescription,
        priority: condition.action_details?.priority || 'medium',
        autoTrigger: condition.action_details?.auto_trigger || false,
      };
    }

    // Return null if no template found
    return null;
  }

  /**
   * Activate lesson tracking and initialize lesson engine
   * @param {Object} lesson - The lesson object
   */
  async activateLessonTracking(lesson) {
    console.log(
      '%c üöÄ Activating lesson tracking for: ' + lesson.lesson_title,
      'background: #2ecc71; color: white; padding: 2px 5px; border-radius: 3px;',
    );

    // Initialize lesson engine if available
    if (window.lessonEngine) {
      // Set the current lesson for tracking
      window.lessonEngine.currentLesson = lesson;
      console.log(
        '‚úÖ Lesson set for tracking:',
        lesson.lesson_id || lesson._id,
      );

      // Initialize the engine for this student if not already done
      if (!window.lessonEngine.initialized) {
        await window.lessonEngine.initialize(this.currentStudent);
        console.log('üîç Lesson engine initialized for student');
      }

      // Make sure the lesson has conditions
      if (lesson.lesson_conditions && Array.isArray(lesson.lesson_conditions)) {
        console.log(
          `üìã Lesson has ${lesson.lesson_conditions.length} conditions`,
        );

        // Ensure each condition has the required properties
        lesson.lesson_conditions.forEach((condition, index) => {
          console.log(
            `Condition ${index + 1}:`,
            condition.condition_type,
            condition.condition_value || condition.value,
          );
        });
      } else {
        console.warn('‚ö†Ô∏è No conditions found for lesson! Check lesson data.');
      }

      // Explicitly call initializeLessonWithRequirements to ensure conditions are loaded
      if (typeof window.initializeLessonWithRequirements === 'function') {
        try {
          const result = await window.initializeLessonWithRequirements(lesson);
          console.log('üéØ Lesson requirements initialized:', result);
        } catch (error) {
          console.error('Error initializing lesson requirements:', error);
        }
      }

      // Force refresh the current lesson in the engine
      try {
        await window.lessonEngine.refreshCurrentLesson();
        console.log('üîÑ Refreshed current lesson in engine');

        // Trigger an explicit check to see if conditions can be evaluated
        const testAction = 'lesson_view';
        const testPayload = { lessonId: lesson.lesson_id || lesson._id };

        console.log(
          'üß™ Testing condition evaluation with action:',
          testAction,
          testPayload,
        );
        const matchedConditions = await window.lessonEngine.evaluateConditions(
          testAction,
          testPayload,
        );

        if (matchedConditions && matchedConditions.length > 0) {
          console.log(
            '‚úÖ Matched conditions found during test:',
            matchedConditions,
          );
        } else {
          console.log(
            '‚ÑπÔ∏è No matched conditions for test action. This is normal for initialization.',
          );
        }
      } catch (error) {
        console.error('Error during lesson engine refresh:', error);
      }
    } else {
      console.warn('‚ö†Ô∏è Lesson engine not available for tracking');
    }

    // Store lesson progress
    this.markLessonAsStarted(lesson);
  }

  /**
   * Mark lesson as started in localStorage
   * @param {Object} lesson - The lesson object
   */
  markLessonAsStarted(lesson) {
    const progressKey = `lesson_progress_${this.currentStudent}`;
    let progress = {};

    try {
      const stored = localStorage.getItem(progressKey);
      if (stored) {
        progress = JSON.parse(stored);
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Error reading lesson progress:', error);
    }

    progress[lesson.lesson_id] = {
      status: 'started',
      startedAt: new Date().toISOString(),
      title: lesson.lesson_title,
    };

    try {
      localStorage.setItem(progressKey, JSON.stringify(progress));
      console.log('üìù Lesson progress saved');
    } catch (error) {
      console.warn('‚ö†Ô∏è Error saving lesson progress:', error);
    }
  }

  /**
   * Display message when no lessons are available
   */
  displayNoLessonsMessage() {
    if (this.contentContainer) {
      this.contentContainer.innerHTML = `
        <div style="
          text-align: center;
          padding: 60px 20px;
          color: #7f8c8d;
          background: linear-gradient(135deg, #f8f9fa, #e9ecef);
          border-radius: 15px;
          margin: 20px 0;
        ">
          <h3>üìö No Lessons Available</h3>
          <p>There are currently no lessons assigned to this student.</p>
          <p>Check back later or contact your instructor for more information.</p>
        </div>
      `;
    }
  }

  /**
   * Display error message when lesson loading fails
   */
  displayLessonsError() {
    if (this.contentContainer) {
      this.contentContainer.innerHTML = `
        <div style="
          text-align: center;
          padding: 60px 20px;
          background: linear-gradient(135deg, #f8d7da, #f5c6cb);
          border: 1px solid #f5c6cb;
          border-radius: 15px;
          margin: 20px 0;
          color: #dc3545;
          width: 100%;
        ">
          <h3>‚ùå Error Loading Lessons</h3>
          <p>There was a problem loading your lessons.</p>
          <p>Please refresh the page or contact support if the problem persists.</p>
        </div>
      `;
    }
  }

  /**
   * Debug method to check lesson engine status
   * This can be called from the browser console to check if lesson tracking is working
   */
  debugLessonEngine() {
    console.log(
      '%c LESSON ENGINE DEBUG INFO',
      'background: #8e44ad; color: white; padding: 5px; font-size: 14px;',
    );

    if (!window.lessonEngine) {
      console.log(
        '%c ‚ùå Lesson engine not found!',
        'color: red; font-weight: bold;',
      );
      return false;
    }

    console.log('%c ‚úÖ Lesson engine instance found', 'color: green;');
    console.log('Initialized:', window.lessonEngine.initialized);
    console.log('Current Student:', window.lessonEngine.currentStudent);

    if (window.lessonEngine.currentLesson) {
      console.log('%c üìö Current Lesson:', 'color: blue; font-weight: bold;');
      console.log('  Title:', window.lessonEngine.currentLesson.lesson_title);
      console.log(
        '  ID:',
        window.lessonEngine.currentLesson.lesson_id ||
          window.lessonEngine.currentLesson._id,
      );

      if (window.lessonEngine.currentLesson.lesson_conditions) {
        console.log('%c üéØ Conditions:', 'color: orange; font-weight: bold;');
        window.lessonEngine.currentLesson.lesson_conditions.forEach(
          (condition, index) => {
            console.log(
              `  ${index + 1}. Type: ${condition.condition_type}, Value: ${condition.condition_value || condition.value}`,
            );
          },
        );
      } else {
        console.log(
          '%c ‚ùå No conditions found in current lesson!',
          'color: red;',
        );
      }

      if (window.lessonEngine.lessonTracker) {
        console.log(
          '%c üìä Tracker State:',
          'color: purple; font-weight: bold;',
        );
        console.log(
          '  Positive Conditions:',
          window.lessonEngine.lessonTracker.getPositiveConditionsCount(),
        );
        console.log(
          '  Negative Conditions:',
          window.lessonEngine.lessonTracker.getNegativeConditionsCount(),
        );
      }
    } else {
      console.log('%c ‚ùå No current lesson set in engine!', 'color: red;');
    }

    return true;
  }

  /**
   * Helper method to close modal overlays
   * @param {Element} modalOverlay - The modal overlay element to close
   */
  closeModal(modalOverlay) {
    if (modalOverlay) {
      modalOverlay.style.opacity = '0';
      modalOverlay.style.pointerEvents = 'none';

      setTimeout(() => {
        if (modalOverlay.parentNode) {
          modalOverlay.parentNode.removeChild(modalOverlay);
        }
      }, 300);
    }
  }
}

// Expose the LessonRenderer class to the global scope for debugging
window.LessonRenderer = LessonRenderer;

/**
 * Render lessons for a given student profile
 * @param {Object} studentProfile - The student profile object
 */
export async function renderLessons(studentProfile) {
  console.log('üî• renderLessons called with profile:', studentProfile);
  console.log('üî• Available containers on page:', {
    lessonsBlock: document.querySelector('.lessonsBlock'),
    'lesson-content': document.getElementById('lesson-content'),
    LessonsBlock: document.querySelector('.LessonsBlock'),
  });

  if (!studentProfile || !studentProfile.memberName) {
    console.error('‚ùå Invalid student profile provided.');
    return;
  }

  // Store the profile globally for future use
  window.currentStudentProfile = studentProfile;

  // Check assignedUnitIds for debugging
  if (studentProfile.assignedUnitIds) {
    console.log('‚úÖ Assigned Unit IDs:', studentProfile.assignedUnitIds);
  } else {
    console.warn('‚ö†Ô∏è No assigned Unit IDs found for the student.');
  }

  // Initialize the lesson renderer for this student
  console.log('üî• Attempting to initialize lesson renderer...');
  const initialized = window.lessonRenderer.initialize(
    studentProfile.memberName,
    'lessonsBlock',
  );

  console.log('üî• Initialization result:', initialized);

  if (!initialized) {
    console.error('‚ùå Failed to initialize lesson renderer.');
    return;
  }

  try {
    const lessons = await window.lessonRenderer.getAvailableLessons();
    console.log('‚úÖ Lessons fetched successfully:', lessons);
    window.lessonRenderer.displayLessonsList(lessons);
  } catch (error) {
    console.error('‚ùå Error fetching lessons:', error);
    window.lessonRenderer.displayLessonsError();
  }
}

// Ensure global lessonRenderer instance is initialized
if (!window.lessonRenderer) {
  window.lessonRenderer = new LessonRenderer();
  console.log('‚úÖ Global lessonRenderer instance initialized.');
}
